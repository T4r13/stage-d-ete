{% extends 'condidatures/base.html' %}

{% block title %}Dashboard Admin - Mobilité Internationale{% endblock %}

{% block content %}
<div class="container mt-8">
    <!-- Header Section -->
    <div class="card mb-8">
        <div class="card-header">
            <h1 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                <i class="fas fa-tachometer-alt" style="color: var(--primary-color);"></i>
                Tableau de Bord Administrateur
            </h1>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="red-gradient" style="color: white; padding: 1.5rem; border-radius: var(--border-radius-lg); border: 2px solid var(--black);">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                        <h3 style="margin: 0; font-size: 2rem;">{{ students_data|length }}</h3>
                        <p style="margin: 0; opacity: 0.9;">Étudiants</p>
                    </div>
                </div>
                <div class="text-center">
                    <div style="background: var(--black); color: white; padding: 1.5rem; border-radius: var(--border-radius-lg); border: 2px solid var(--primary-color);">
                        <i class="fas fa-file-alt" style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--white) !important; opacity: 0.9;"></i>
                        <h3 style="margin: 0; font-size: 2rem; color: var(--white) !important;">{{ candidatures|length }}</h3>
                        <p style="margin: 0; opacity: 0.9; color: var(--white) !important;">Candidatures</p>
                    </div>
                </div>
                <div class="text-center">
                    <div style="background: var(--white); color: var(--black); padding: 1.5rem; border-radius: var(--border-radius-lg); border: 2px solid var(--black);">
                        <i class="fas fa-briefcase" style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary-color);"></i>
                        <h3 style="margin: 0; font-size: 2rem; color: var(--black);">0</h3>
                        <p style="margin: 0; opacity: 0.9; color: var(--black);">Offres Actives</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profils Étudiants Section -->
    <div class="card mb-8">
        <div class="card-header">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-user-graduate" style="color: var(--primary-color);"></i>
                Profils Étudiants
            </h2>
        </div>
        <div class="card-body" style="padding: 0;">
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-user"></i> Nom d'utilisateur</th>
                            <th><i class="fas fa-id-card"></i> Identifiant</th>
                            <th><i class="fas fa-chart-line"></i> Moyenne</th>
                            <th><i class="fas fa-language"></i> Langues</th>
                            <th><i class="fas fa-running"></i> Activités</th>
                            <th><i class="fas fa-star"></i> Score Final</th>
                            <th><i class="fas fa-calendar"></i> Date de Calcul</th>
                            <th><i class="fas fa-trophy"></i> Rang</th>
                            <th><i class="fas fa-calendar-alt"></i> Année</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students_data %}
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 32px; height: 32px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        {{ student.username|first|upper }}
                                    </div>
                                    {{ student.username }}
                                </div>
                            </td>
                            <td><span style="background: var(--gray-100); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-family: monospace;">{{ student.identifiant }}</span></td>
                            <td>
                                <span style="background: {% if student.moyenne >= 15 %}var(--success-color){% elif student.moyenne >= 12 %}var(--warning-color){% else %}var(--danger-color){% endif %}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: bold;">
                                    {{ student.moyenne|default:"N/A" }}
                                </span>
                            </td>
                            <td>{{ student.langues|default:"N/A" }}</td>
                            <td>{{ student.activites|default:"Aucune activité" }}</td>
                            <td>
                                <span style="background: var(--primary-color); color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: bold;">
                                    {{ student.score_final|default:"N/A" }}
                                </span>
                            </td>
                            <td>{{ student.date_calcul|date:"d/m/Y" }}</td>
                            <td>
                                <span style="background: var(--gray-200); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: bold;">
                                    {{ student.rang|default:"N/A" }}
                                </span>
                            </td>
                            <td>{{ student.annee }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center" style="padding: 2rem; color: var(--gray-500);">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                                Aucun profil disponible.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Candidatures Section -->
    <div class="card mb-8">
        <div class="card-header">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-file-alt" style="color: var(--success-color);"></i>
                Candidatures
            </h2>
        </div>
        <div class="card-body" style="padding: 0;">
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-user"></i> Candidat</th>
                            <th><i class="fas fa-briefcase"></i> Offre</th>
                            <th><i class="fas fa-building"></i> Entreprise</th>
                            <th><i class="fas fa-calendar"></i> Date de candidature</th>
                            <th><i class="fas fa-info-circle"></i> Statut</th>
                            <th><i class="fas fa-cogs"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for candidature in candidatures %}
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 32px; height: 32px; background: var(--success-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        {{ candidature.candidat.username|first|upper }}
                                    </div>
                                    {{ candidature.candidat.username }}
                                </div>
                            </td>
                            <td><strong>{{ candidature.offre.titre }}</strong></td>
                            <td>{{ candidature.offre.entreprise }}</td>
                            <td>{{ candidature.date_candidature|date:"d/m/Y" }}</td>
                            <td>
                                <span style="background: {% if candidature.statut == 'acceptee' %}var(--success-color){% elif candidature.statut == 'refusee' %}var(--danger-color){% else %}var(--warning-color){% endif %}; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;">
                                    {{ candidature.statut|default:"En attente" }}
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-success" style="padding: 0.5rem 1rem; font-size: 0.75rem;" onclick="changerStatut({{ candidature.id }}, 'acceptee', this)">
                                        <i class="fas fa-check"></i> Accepter
                                    </button>
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.75rem;" onclick="changerStatut({{ candidature.id }}, 'refusee', this)">
                                        <i class="fas fa-times"></i> Refuser
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center" style="padding: 2rem; color: var(--gray-500);">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                                Aucune candidature reçue.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="card">
        <div class="card-body text-center">
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <a href="{% url 'ajouter_offre' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Ajouter une Offre de Stage
                </a>
                <a href="{% url 'liste_offres' %}" class="btn btn-secondary">
                    <i class="fas fa-list"></i>
                    Voir les Offres
                </a>
                <a href="{% url 'logout' %}" class="btn btn-outline">
                    <i class="fas fa-sign-out-alt"></i>
                    Déconnexion
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function changerStatut(candidatureId, statut, button) {
    // Disable button during request
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
    
    fetch("{% url 'changer_statut_ajax' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: `candidature_id=${candidatureId}&statut=${statut}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update status in table
            const statusCell = button.closest('tr').querySelector('td:nth-child(5)');
            const statusSpan = statusCell.querySelector('span');
            statusSpan.textContent = statut === 'acceptee' ? 'acceptee' : 'refusee';
            statusSpan.style.background = statut === 'acceptee' ? 'var(--success-color)' : 'var(--danger-color)';
            
            // Show success message
            showNotification('Statut mis à jour avec succès!', 'success');
        } else {
            showNotification("Erreur lors du changement de statut.", 'error');
        }
    })
    .catch(() => {
        showNotification("Erreur réseau lors du changement de statut.", 'error');
    })
    .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = statut === 'acceptee' ? '<i class="fas fa-check"></i> Accepter' : '<i class="fas fa-times"></i> Refuser';
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type}`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '1000';
    notification.style.minWidth = '300px';
    notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}
